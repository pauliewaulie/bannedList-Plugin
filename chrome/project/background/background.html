<html>
<script src="../js/jquery-1.7.1.min_plus_highlight.js" type="text/javascript"></script>
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28859929-1']);
    _gaq.push(['_trackPageview']);

    (function() { // See: http://code.google.com/chrome/extensions/tut_analytics.html
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<script type="text/javascript">
    $(document).ready(function () {
        chrome.extension.onRequest.addListener( function( request, sender, sendResponse) {
            if (request.method == "getOptions") {
                if ( localStorage.length == 0) {    // Set defaults!
                    localStorage["extras.politics.andrew1"] = true;
                }

                if (/http.*twitter.com/.test( sender.tab.url )) {
                    setInterval( function() {
                        sendResponse({method: "getOptions", url: sender.tab.url, options: localStorage});
                    }, 2500);
                }
                else /* Non Twitter can update now! */ {
                    sendResponse({method: "getOptions", url: sender.tab.url, options: localStorage});
                }
            }
            else if (request.method == "notify") {
                var theNotif = webkitNotifications.createNotification('../img/icon48.png', request.heading, request.msg);
                theNotif.show();
            }
            else if (request.method == "setBadge") {
                if ( request.score <= 0) {
                    resetBadge(sender);
                }
                else {
                    if ( request.score <= 3) {
                        chrome.browserAction.setBadgeBackgroundColor({ color: [255,127,0, 255], tabId: sender.tab.id});
                    }
                    else if ( request.score <= 8) {
                        chrome.browserAction.setBadgeBackgroundColor({ color: [255,70,70, 255], tabId: sender.tab.id});
                    }
                    else {
                        chrome.browserAction.setBadgeBackgroundColor({ color: [220,0,0, 255], tabId: sender.tab.id});
                    }

                    localStorage['$stats.score'] = request.score;
                    localStorage['$stats.url'] = request.url;

                    chrome.browserAction.setBadgeText({ text: '' + request.score, tabId: sender.tab.id});
                    chrome.browserAction.setTitle({ title: 'BannedList Score for this page: ' + request.score, tabId: sender.tab.id});
                    chrome.browserAction.setPopup({ popup: 'popup/shareResults.html', tabId: sender.tab.id});
                }
            }
            else if (request.method == "resetBadge") {
                resetBadge(sender);
            }
            else if (request.method == "getDetailsForPopup") {
                sendResponse({method: "detailsForPopupResponse", score: localStorage['$stats.score'], url: localStorage['$stats.url']});
            }
            else {
                sendResponse({}); // snub them.
            }
        });

        function clickSubmit( inInfo, inTab) {
	    chrome.tabs.sendRequest( inTab.id, {
	        method: "showSubmitOptions",
	        pageUrl: inInfo.pageUrl,
		phrase: inInfo.selectionText
	    }, function (response) {
	        if ( response.ok != "true") {
	            alert('Error!');
	        }
	    });
        }

        function resetBadge(inSender) {
            chrome.browserAction.setBadgeText({ text: '', tabId: inSender.tab.id});
            chrome.browserAction.setTitle({ title: 'BannedList Score for this page: 0', tabId: inSender.tab.id});
            chrome.browserAction.setPopup({ popup: '', tabId: inSender.tab.id});
        }

        var menuId = chrome.contextMenus.create({"title": 'Submit new phrase...', "contexts":['selection'], "onclick": clickSubmit});
    });
</script>
</html>